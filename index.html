<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Overview Â· Drafts</title>

    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/h.js"></script>
  </head>
  <body>
    <main>
      <header>
        <h1>Drafts</h1>
      </header>
      <nav>
        <p><a href="/editor"><strong>+new draft</strong></a></p>
        <p>Drafts are stored in your browser's local storage. This means that they will not automatically synchronize with a server or any other device. It also means that <strong>you might lose your drafts</strong> when the browser cache is cleared!</p>
        <p>Use the <em>Download</em> feature to store important drafts safely on your file system.</p>
      </nav>
    </main>
    <script>
      var nav = document.querySelector('nav')
      var stored = Object.keys(localStorage)
      var deleted = Object.keys(sessionStorage)

      if (stored.length) {
        var drafts = h('ul', {}, stored.map(link.bind(null, 'editor')))
        nav.appendChild(h('hr'))
        nav.appendChild(h('p', {}, 'Want to revisit a previous draft?'))
        nav.appendChild(drafts)
      }

      if (deleted.length) {
        var trash = h('ul', {}, deleted.map(link.bind(null, 'trash')))
        var empty = h('button', { type: 'button', name: 'purge' }, 'Empty Trash')
        empty.addEventListener('click', purge)

        nav.appendChild(h('hr'))
        nav.appendChild(h('p', {}, 'Need to recover something from the trash?'))
        nav.appendChild(trash)
        nav.appendChild(empty)
      }

      function link (page, key) {
        var name = decodeURIComponent(key)
        var href = `/${page}?draft=${key}`
        return h('li', {}, h('a', { href }, name))
      }

      function purge () {
        var name = 'all trash'
        var check = prompt(`Purge ${name}? Type 'purge' to confirm.`)
        if (check.toLowerCase() !== 'purge') return alert(`Purge not confirmed, ${name} was kept`)
        deleted.forEach(sessionStorage.removeItem.bind(sessionStorage))
        window.location.reload()
      }
    </script>
  </body>
</html>
