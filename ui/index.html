<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Draft</title>

    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/screen.css" media="screen">
    <link rel="stylesheet" jref="/css/print.css" media="print">
  </head>
  <body>
    <main id="main">
      <h1><a href="https://github.com/pamphlets/draft">Draft</a></h1>
      <form>
        <fieldset>
          <label>Title:</label>
          <input type="text" id="title">
        </fieldset>
        <fieldset>
          <label>User:</label>
          <input type="text" id="username">
        </fieldset>
        <fieldset>
          <button id="browse">Open</button>
        </fieldset>
      </form>
      <article id="writer"></article>
    </main>
    <dialog id="popup" class="popup">
      <h1>Open Draft</h1>
      <ul class="drafts"></ul>
      <section class="actions">
        <button id="cancel" class="cancel">Close</button>
      </section>
    </dialog>
    <aside id="alerts"></aside>

    <script type="module">
      import { Draft, debounce } from '/js/draft.js'

      var url = new URL(location)
      var user = loadUser()

      window.draft = new Draft(window.writer, url.searchParams.get('room'), user)
      window.title.setAttribute('placeholder', 'Untitled')
      window.username.setAttribute('placeholder', draft.user.name)

      if (user) {
        window.username.value = user.name
      }

      if (url.searchParams.has('room')) {
        window.title.value = localStorage.getItem('title|' + draft.room)
      } else {
        url.searchParams.set('room', draft.room)
        history.pushState({}, '', url)
      }

      if (!window.title.value) {
        sessionStorage.setItem('recent|' + draft.room, Date.now())
      }

      window.title.addEventListener('input', debounce(event => {
        localStorage.setItem('title|' + draft.room, event.target.value)
      }, 750))

      window.username.addEventListener('input', debounce(event => {
        draft.user = { name: event.target.value }
        localStorage.setItem('user', JSON.stringify(draft.user))
      }, 750))

      window.browse.addEventListener('click', event => {
        event.preventDefault()
        window.popup.toggleAttribute('open')
        window.main.classList.add('blur')
      })

      window.cancel.addEventListener('click', event => {
        event.preventDefault()
        window.popup.toggleAttribute('open')
        window.main.classList.remove('blur')
      })

      //=====

      function loadUser () {
        try {
          return JSON.parse(localStorage.user)
        } catch (err) {
          console.debug(err)
          return null
        }
      }
    </script>
  </body>
</html>
